{% extends 'inventario_app/base.html' %}
{% load static %}

    {% block body %}
   
    <div style='background-color:#abb7b7' class="jumbotron text-center expand">
        <h1 class="">Bienvenidos a Funes Dulceria</h1>
        <p class="lead text-muted">Eleg√≠ lo que quieras y te lo enviamos a tu casa<p>
    </div>

    <div style="padding: 10px" class="row shadow-lg border boder-light">
        <div class='d-inline-flex'>
            <h3>MAS POPULARES</h3>
        </div>
        <div class="row">
            {% for product in featured %}
            <div class=" p-3 col-lg-3 col-md-3 col-sm-3">
                <a href="{% url 'detail' id=product.id%}"><img class="img-thumbnail" src="{{product.image.url}}"></a>
                <div class="box-element product p-3">
                    <h6 class="pt-2" style="display: inline-block; float: right">${{product.price}}</h6>
                    <a href="{% url 'detail' id=product.id%}"><h6 class="pt-2" style="display: inline-block"><strong>{{product.name}}</strong></h6></a>
                    <!-- <a class="btn btn-outline-primary btn-sm" href="{% url 'detail' id=product.id%}">Detalles</a> -->
                    {% if user.is_authenticated %}
                    <a class="btn btn-outline-secondary btn-sm" href="{% url 'update' id=product.id%}">Actualizar</a>
                    {% endif %}
                </div>
                <br>
            </div>
            {% endfor %}
        </div> 
    </div>
    <hr>

    <div id='product-details' class="row">
		
		</div>
    </div>
   <script>

    buildProductsList()

    function buildProductsList(){
		const url = '/api/product-list/'

		fetch(url)
			.then(function(response) { return response.json(); })
            .then(updateProducts);
    
        }

        
    function updateProducts(products){
        console.log(products)
        localStorage.setItem('products', JSON.stringify(products))
        
        renderProducts(products)

        products.forEach((product) => {
            lo_quiero_atag = document.getElementById('lo-quiero ' + product.id)
            lo_quiero_atag.addEventListener('click', (a) => {
                a.preventDefault()
                return addProductOrCreateOrder(product)
            });

        });

        function addProductOrCreateOrder(product){
            console.log(product.id)
            if(localStorage.getItem('order')){
                order = JSON.parse(localStorage.getItem('order'))
                    if(order[product.name]){
                        order[product.name].quantity += 1
                    }else{
                        order[product.name] = {'id':product.id,'name':product.name,'price':product.price,'quantity':1}
                    }
            }else{
                order = {}
                order[product.name] = {'id':product.id,'name':product.name,'price':product.price,'quantity':1}
            }
        localStorage.setItem('order', JSON.stringify(order))
        };
       

        function renderProducts(products) {
            p = products
            products_row = document.getElementById('product-details');
            products.forEach((product) => {
                products_row.innerHTML += `
                <div class="col-lg-3 col-md-3 col-sm-3">
                    <a href=""><img class="img-thumbnail" src=${product.image}></a>
                    <div class="box-element product">
                        <a href=""><h6 class="pt-2" style="display: inline-block"><strong>${product.name}</strong></h6></a>
                        <h6 class="pt-2" style="display: inline-block; float:right">${product.price}</h6>				
                        <br><a id='lo-quiero ${product.id}' class="btn btn-success btn-sm" href="">Lo Quiero</a>
                        {% if user.is_authenticated %}
                        <a class="btn btn-outline-secondary btn-sm" href="">A</a>
                        {% endif %}
                    </div>
                    <br>
                </div>
                `
            });
        };

    }
    

   </script>
    {% endblock body %}